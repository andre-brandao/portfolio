---
title: Menu and Ordering System BackEnd v2.0
description: A menu and ordering system for Villa Rica Pousada.
date: '2023-10-28'
categories:
  - sveltekit
  - supabase
  - SQL
  - postgreensSQL
published: true
---

## Table of Contents

## Still in progrees!!!!

## Tables
![supa tables](supabase-tables.png)
### cliente

```sql
create table
  public.clientes (
    created_at timestamp with time zone not null default now(),
    nome text not null default ''::text,
    telefone text not null default ''::text,
    mesa text not null default ''::text,
    id uuid not null default gen_random_uuid (),
    constraint clientes_pkey primary key (id)
  ) tablespace pg_default;
```

### pedidos

```sql
create table
  public.pedidos (
    id bigint generated by default as identity,
    created_at timestamp with time zone not null default now(),
    cliente_id uuid not null default auth.uid (),
    quantidade smallint not null default '1'::smallint,
    produto bigint not null default '0'::bigint,
    status text not null default 'Pendente'::text,
    observacao text not null default ''::text,
    updated_by uuid null,
    total_in_cents bigint not null default '0'::bigint,
    constraint pedidos_pkey primary key (id),
    constraint pedidos_cliente_id_fkey foreign key (cliente_id) references clientes (id),
    constraint pedidos_produto_fkey foreign key (produto) references produtos (id),
    constraint pedidos_updated_by_fkey foreign key (updated_by) references info_admin (id)
  ) tablespace pg_default;

create trigger set_pedido_total_trigger before insert on pedidos for each row
execute function update_pedido_total ();
```

### produtos

```sql
create table
  public.produtos (
    id bigint generated by default as identity,
    created_at timestamp with time zone not null default now(),
    nome text not null default ''::text,
    descricao text not null default ''::text,
    preco_in_cents bigint not null,
    categoria text not null default ''::text,
    sub_categoria text not null default ''::text,
    image_url text not null default ''::text,
    vegan boolean not null default false,
    visible boolean not null default true,
    constraint products_pkey primary key (id),
    constraint products_name_key unique (nome)
  ) tablespace pg_default;
```


## Policies

![policies](supabase-policies.png)

## Triggers and Functions

### new info admin on register

```sql
create
or replace function public.handle_new_user () returns trigger as $$
begin
  insert into public.info_admin (id, email)
  values (new.id, new.email);
  return new;
end;

-- $$ language plpgsql security definer;

create trigger on_new_user
after insert on auth.users for each row
execute procedural public.handle_new_auth ();
```

### calculate total automaticly
```sql

CREATE
OR REPLACE FUNCTION update_pedido_total () RETURNS TRIGGER AS $$
BEGIN
  -- Calculate the total_in_cents before inserting the new row
  NEW.total_in_cents = (SELECT preco_in_cents FROM produtos WHERE id = NEW.produto) * NEW.quantidade;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE
or replace TRIGGER set_pedido_total_trigger BEFORE INSERT ON pedidos FOR EACH ROW
EXECUTE
  FUNCTION update_pedido_total ();
```